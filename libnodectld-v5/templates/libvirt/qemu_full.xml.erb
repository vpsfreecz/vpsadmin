<domain type="kvm">
  <name><%= name %></name>
  <uuid><%= uuid %></uuid>

  <seclabel type='none' model='dac'/>

  <memory unit="MiB"><%= memory %></memory>

  <vcpu><%= cpu %></vcpu>

  <cputune>
    <% if cpu_quota > 0 %>
    <period><%= cpu_period %></period>
    <quota><%= cpu_quota %></quota>
    <% end %>
  </cputune>

  <os>
    <type arch="x86_64">hvm</type>
    <boot dev='hd'/>
    <boot dev='cdrom'/>
    <bootmenu enable='yes'/>
  </os>

  <features>
    <acpi/>
    <apic/>
  </features>

  <cpu mode="host-passthrough"/>

  <clock offset="utc"/>
  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>restart</on_crash>

  <devices>
    <emulator><%= qemu %></emulator>

    <disk type="file" device="disk">
      <driver name="qemu" type="<%= rootfs[:type] %>"/>
      <source file="<%= rootfs[:path] %>"/>
      <target dev="vdc" bus="virtio"/>
      <serial><%= rootfs[:serial] %></serial>
    </disk>

    <disk type='file' device='disk'>
      <driver name='qemu' type='raw'/>
      <source file='<%= config_path %>'/>
      <target dev='vdb' bus='virtio'/>
      <serial>vpsadmin-config-drive</serial>
      <readonly/>
    </disk>

    <channel type='unix'>
      <source mode='bind'/>
      <target type='virtio' name='org.qemu.guest_agent.0'/>
    </channel>

    <rng model="virtio">
      <backend model="random">/dev/urandom</backend>
    </rng>

    <memballoon model="virtio"/>

    <graphics type='vnc' port='-1' autoport='yes' listen='127.0.0.1'>
      <listen type='address' address='127.0.0.1'/>
    </graphics>

    <video>
      <model type='virtio' heads='1' primary='yes'/>
    </video>

    <controller type='usb' model='qemu-xhci'/>

    <input type='tablet' bus='usb'/>

    <input type='mouse' bus='ps2'/>

    <input type='keyboard' bus='ps2'/>

    <% network_interfaces.each do |netif| -%>
      <%= ErbTemplate.render('libvirt/network_interface.xml', netif) %>
    <% end -%>
  </devices>
</domain>
