<domain type="kvm">
  <name><%= name %></name>
  <uuid><%= uuid %></uuid>

  <seclabel type='none' model='dac'/>

  <memory unit="MiB"><%= memory %></memory>
  <vcpu><%= cpu %></vcpu>

  <os>
    <type arch="x86_64">hvm</type>
    <boot dev='hd'/>
    <boot dev='cdrom'/>
    <bootmenu enable='yes'/>
  </os>

  <features>
    <acpi/>
    <apic/>
  </features>

  <cpu mode="host-passthrough"/>

  <clock offset="utc"/>
  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>restart</on_crash>

  <devices>
    <emulator><%= qemu %></emulator>

    <disk type="file" device="disk">
      <driver name="qemu" type="<%= rootfs_type %>"/>
      <source file="<%= rootfs_path %>"/>
      <target dev="vdc" bus="virtio"/>
    </disk>

    <console type='tcp'>
      <source mode='connect' host='localhost' service='<%= console_port %>'>
        <reconnect enabled='yes' timeout='1'/>
      </source>
      <protocol type='raw'/>
      <target type='virtio' port='0'/>
    </console>

    <channel type='unix'>
      <source mode='bind'/>
      <target type='virtio' name='org.qemu.guest_agent.0'/>
    </channel>

    <rng model="virtio">
      <backend model="random">/dev/urandom</backend>
    </rng>

    <memballoon model="virtio"/>

    <graphics type='vnc' port='-1' autoport='yes' listen='127.0.0.1'>
      <listen type='address' address='127.0.0.1'/>
    </graphics>

    <video>
      <model type='virtio' heads='1' primary='yes'/>
    </video>

    <controller type='usb' model='qemu-xhci'/>

    <input type='tablet' bus='usb'/>

    <input type='mouse' bus='ps2'/>

    <input type='keyboard' bus='ps2'/>

    <% network_interfaces.each do |netif| -%>
      <%= ErbTemplate.render('libvirt/network_interface.xml', netif) %>
    <% end -%>
  </devices>
</domain>
