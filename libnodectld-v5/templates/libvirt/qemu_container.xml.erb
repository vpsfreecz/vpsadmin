<domain type="kvm">
  <name><%= name %></name>
  <uuid><%= uuid %></uuid>

  <seclabel type='none' model='dac'/>

  <memory unit="MiB"><%= memory %></memory>
  <vcpu><%= cpu %></vcpu>

  <os>
    <type arch="x86_64">hvm</type>
    <kernel><%= kernel_path %></kernel>
    <cmdline><%= kernel_cmdline %></cmdline>
  </os>

  <features>
    <acpi/>
    <apic/>
  </features>

  <cpu mode="host-passthrough"/>

  <clock offset="utc"/>
  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>restart</on_crash>

  <devices>
    <emulator><%= qemu %></emulator>

    <disk type="file" device="disk">
      <driver name="qemu" type="<%= stage2_type %>"/>
      <source file="<%= stage2_path %>"/>
      <target dev="vda" bus="virtio"/>
      <serial>vpsadmin-stage-2</serial>
      <readonly/>
    </disk>

    <disk type='file' device='disk'>
      <driver name='qemu' type='raw'/>
      <source file='<%= config_path %>'/>
      <target dev='vdb' bus='virtio'/>
      <serial>vpsadmin-config-drive</serial>
      <readonly/>
    </disk>

    <disk type="file" device="disk">
      <driver name="qemu" type="<%= rootfs[:type] %>"/>
      <source file="<%= rootfs[:path] %>"/>
      <target dev="vdc" bus="virtio"/>
      <serial><%= rootfs[:serial] %></serial>
    </disk>

    <% if rescuefs -%>
    <disk type="file" device="disk">
      <driver name="qemu" type="<%= rescuefs[:type] %>"/>
      <source file="<%= rescuefs[:path] %>"/>
      <target dev="vdd" bus="virtio"/>
      <serial><%= rescuefs[:serial] %></serial>
    </disk>
    <% end -%>

    <console type='tcp'>
      <source mode='connect' host='localhost' service='<%= console_port %>'>
        <reconnect enabled='yes' timeout='1'/>
      </source>
      <protocol type='raw'/>
      <target type='virtio' port='0'/>
    </console>

    <console type='pty'>
      <target type='virtio' port='1'/>
    </console>

    <console type='pty'>
      <target type='virtio' port='2'/>
    </console>

    <channel type='unix'>
      <source mode='bind'/>
      <target type='virtio' name='org.qemu.guest_agent.0'/>
    </channel>

    <rng model="virtio">
      <backend model="random">/dev/urandom</backend>
    </rng>

    <memballoon model="virtio"/>

    <% network_interfaces.each do |netif| -%>
      <%= ErbTemplate.render('libvirt/network_interface.xml', netif) %>
    <% end -%>
  </devices>
</domain>
