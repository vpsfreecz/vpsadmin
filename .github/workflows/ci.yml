name: CI

on:
  push:
    paths:
      - .github/workflows/ci.yml
      - api/**
      - client/**
      - console_router/**
      - libnodectld/**
      - nixos/**
      - nodectl/**
      - nodectld/**
      - packages/**
      - plugins/**
      - tests/**
      - tools/**
      - webui/**

permissions:
  contents: read

env:
  NIX_PATH: nixpkgs=https://channels.nixos.org/nixos-25.11/nixexprs.tar.xz
  VPSADMINOS_PATH: ${{ github.workspace }}/vpsadminos

jobs:
  test:
    name: Run ci-tagged tests
    runs-on: self-hosted
    timeout-minutes: 360

    steps:
      - name: Checkout vpsadmin
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout vpsadminos (test-runner)
        uses: actions/checkout@v4
        with:
          repository: vpsfreecz/vpsadminos
          path: vpsadminos
          fetch-depth: 1

      - name: Determine job count
        id: determine-test-jobs
        uses: ./.github/actions/determine-test-jobs
        with:
          per_job_gib: "20"

      - name: Run tests
        id: run-tests
        timeout-minutes: 320
        run: |
          set -o pipefail
          ./test-runner.sh test -f -j "${{ steps.determine-test-jobs.outputs.jobs }}" -t ci | tee test.log

      - name: Evaluate test results
        if: always()
        run: |
          EXPECTED_SUCCESSFUL=$(grep -oP "\d+ tests successful" test.log | cut -f1 -d ' ')
          EXPECTED_FAILED=$(grep -oP "\d+ tests failed as expected" test.log | cut -f1 -d ' ')
          UNEXPECTED_FAILED=$(grep -oP "\d+ tests should have succeeded" test.log | cut -f1 -d ' ')
          UNEXPECTED_SUCCESSFUL=$(grep -oP "\d+ tests should have failed" test.log | cut -f1 -d ' ')

          echo "expected_successful=${EXPECTED_SUCCESSFUL:-0}" >> $GITHUB_OUTPUT
          echo "expected_failed=${EXPECTED_FAILED:-0}" >> $GITHUB_OUTPUT
          echo "unexpected_failed=${UNEXPECTED_FAILED:-0}" >> $GITHUB_OUTPUT
          echo "unexpected_successful=${UNEXPECTED_SUCCESSFUL:-0}" >> $GITHUB_OUTPUT

          {
            echo '### Test summary'
            echo ""
            echo "| Result | Count |"
            echo "|--------|-------|"
            echo "| ✅ Successful (expected) | ${EXPECTED_SUCCESSFUL:-0} |"
            echo "| ⚠️ Failed (expected) | ${EXPECTED_FAILED:-0} |"
            echo "| ❌ Failed (unexpected) | ${UNEXPECTED_FAILED:-0} |"
            echo "| ❌ Successful (unexpected) | ${UNEXPECTED_SUCCESSFUL:-0} |"
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          if [ "${UNEXPECTED_FAILED:-0}" -gt 0 ] || [ "${UNEXPECTED_SUCCESSFUL:-0}" -gt 0 ]; then
            echo "::error::${UNEXPECTED_FAILED:-0} tests unexpectedly failed, ${UNEXPECTED_SUCCESSFUL:-0} tests unexpectedly succeeded"
            exit 1
          fi

      - name: Summarise test logs
        if: always()
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          logs_root=/tmp/os-test-runner

          if [ -d "$logs_root" ]; then
            echo "## Per-test logs (tail, last 200 lines each)" >>"$summary_file"
            echo >>"$summary_file"

            # One collapsible <details> section per test
            for test_dir in "$logs_root"/os-test-*; do
              test_name=$(basename "$test_dir")
              result_file="$test_dir"/test-result.txt

              [ -e "$result_file" ] || continue

              test_result=$(cat "$test_dir"/test-result.txt)

              if [ "$test_result" == "expected_success" ] || [ "$test_result" == "expected_failure" ]; then
                continue
              fi

              echo "<details><summary><code>$test_name</code></summary>" >>"$summary_file"
              echo >>"$summary_file"

              for f in "$test_dir"/*.log; do
                echo "#### $(basename "$f")" >>"$summary_file"
                echo '```' >>"$summary_file"
                tail -n 200 "$f" >>"$summary_file"
                echo '```' >>"$summary_file"
                echo >>"$summary_file"
              done

              echo '</details>' >>"$summary_file"
              echo >>"$summary_file"
            done
          fi

      - name: Upload full test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vpsadmin-test-logs-${{ github.run_id }}
          path: |
            /tmp/os-test-runner/**/*.log
            /tmp/os-test-runner/**/*.txt
          retention-days: 14
          if-no-files-found: ignore
